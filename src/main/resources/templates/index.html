<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Box</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 100vh;
            background-color: #e0e0e0;
        }

        .dialog-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            background-color: #ffffff;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            border-top: 1px solid #ddd;
        }

        .dialog-box {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 700px;
        }

        .dialog-box textarea {
            flex-grow: 1;
            height: 60px;
            resize: none;
            padding: 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-right: 12px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            /* Ensure padding is included in the width */
            vertical-align: middle;
            /* Align vertically with the button */
            line-height: 1.4;
            /* Ensure consistent vertical alignment */
        }

        .dialog-box button {
            padding: 14px 24px;
            font-size: 16px;
            background-color: #007BFF;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap;
            /* Prevent the text from wrapping */
            line-height: 1.4;
            /* Ensure consistent vertical alignment */
            display: inline-flex;
            /* Ensure proper alignment */
            align-items: center;
            /* Align vertically within the button */
        }


        .dialog-box button:hover {
            background-color: #0056b3;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 100%;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            /* Ensure rounded corners are respected */
        }

        .message-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f7f7f7;
        }

        .message {
            padding: 15px;
            margin: 8px 0;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: fit-content;
            min-width: 20%;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        .message-text {
            margin: 0;
            padding: 5px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message-time {
            padding: 5px;
            line-height: 0.6;
            position: absolute;
            font-size: 12px;
            color: #888;
            bottom: 5px;
            right: 5px;
        }
    </style>
</head>

<body>
<div class="chat-container">

    <!-- Messages -->
    <div class="message-list" id="messageList"><div class="message" style="background-color: rgb(160, 58, 161);"><p class="message-text">asdfasdfasjdhfkadfladhkahdffsadlfhalkdhflakdhflkahdfjsahdkhasljdfhasldhflashdflkahdfashdfhsaskdf</p><span class="message-time">12:56</span></div><div class="message" style="background-color: rgb(160, 58, 161);"><p class="message-text">asdfadf</p><span class="message-time">12:56</span></div><div class="message" style="background-color: rgb(160, 58, 161);"><p class="message-text">asdf</p><span class="message-time">12:56</span></div><div class="message" style="background-color: rgb(160, 58, 161);"><p class="message-text">asdf</p><span class="message-time">12:57</span></div><div class="message" style="background-color: rgb(69, 83, 191);"><p class="message-text">Hi</p><span class="message-time">12:58</span></div><div class="message" style="background-color: rgb(245, 100, 201);"><p class="message-text">asdf</p><span class="message-time">15:54</span></div></div>

    <!-- Dialog Box at Bottom -->
    <div class="dialog-container">
        <div class="dialog-box">
            <form action="/api/v1/chat/sendMessage" method="post" id="chatForm">
                <textarea id="messageInput" name="message" placeholder="Type your message here..."></textarea>
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
</div>

<script>
    const messageInput = document.getElementById("messageInput");
    messageInput.focus();

    document.addEventListener("DOMContentLoaded", function() {
        // Function to scroll the message list to the bottom
        function scrollToBottom() {
            const messageList = document.querySelector('.message-list');
            messageList.scrollTop = messageList.scrollHeight;
        }

        // Scroll to the bottom on page load
        scrollToBottom();
        document.getElementById("chatForm").addEventListener("submit", function(event) {
            // Wait a bit for the DOM to update
            setTimeout(scrollToBottom, 100); // Adjust timeout as needed
        });
    });
    document.addEventListener("keydown", function(event) {
        const messageInput = document.getElementById("messageInput");

        if (event.key === "Enter") {
            if (document.activeElement !== messageInput) {
                // If the dialog box (textarea) is not focused, focus on it
                event.preventDefault();
                messageInput.focus();
            } else {
                // If the dialog box is already focused, submit the form
                event.preventDefault(); // Prevent newline behavior
                document.getElementById("chatForm").submit();
            }
        }
    });


    function fetchMessages() {
        fetch('/api/v1/message/getMessages')
            .then(response => response.json())
            .then(messages => {
                const messageList = document.getElementById('messageList');
                messageList.innerHTML = ''; // Clear existing messages
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message';

                    const color = hashToColor(message.requestHash);

                    // color = hashToColor(message.requestHash);

                    // Set background color for the message
                    messageDiv.style.backgroundColor = color;

                    // Create message text element
                    const messageText = document.createElement('p');
                    messageText.className = 'message-text';
                    messageText.textContent = message.text;

                    // Create timestamp element
                    const messageTime = document.createElement('span');
                    messageTime.className = 'message-time';
                    messageTime.textContent = formatTimestamp(message.timeStamp);

                    // Append text and time to the message div
                    messageDiv.appendChild(messageText);
                    messageDiv.appendChild(messageTime);

                    messageList.appendChild(messageDiv);
                });
            })
            .catch(error => console.error('Error fetching messages:', error));
    }

    // Initial fetch
    fetchMessages();

    // Fetch messages every second
    setInterval(fetchMessages, 1000);

    let colorMap = new Map();
    function saveColor(message){
        colorMap.set(message.requestHash,message.text);
    }
    function hashToColor(hash) {
        if(colorMap.get(hash) != null){
            return colorMap.get(hash);
        }
        // Ensure the hash is treated as a number
        let hashValue = parseInt(hash, 10);

        // Ensure hashValue is positive (for simplicity)
        hashValue = Math.abs(hashValue);

        // Convert the hash value to a 6-digit hexadecimal color
        let color = '#' + ('000000' + (hashValue & 0xFFFFFF).toString(16)).slice(-6);

        return color;
    }


    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`; // Format as HH:MM
    }

</script>
</body>

</html>